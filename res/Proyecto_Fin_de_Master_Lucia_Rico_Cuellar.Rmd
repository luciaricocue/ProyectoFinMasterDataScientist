---
title: "Proyecto Fin de Master"
author: "Lucia Rico Cuellar"
date: "3 de julio de 2017"
output: html_document
---
<meta http-equiv='Content-Type' content='text/html; charset=utf-8' /> 

```{r, include=FALSE}

library(data.table)
library(reshape)
library(zoo)
library(lubridate)
library(readr) 
library(stats)
library(xts)
library(tidyquant)
library(forecast)
library(ggplot2)
# setwd("C:/Users/Lucía/Desktop/ProyectoFinMasterDataScientist")
source("../src/funciones.R")

```


```{r, include=FALSE }

# montmelo_la_junquera <- fread("../dat/06020101_montmelo_la_junquera.csv")
# sevilla_cadiz <- fread("../dat/06020203_sevilla_cadiz.csv")
```

Vamos a usar los datos de series mensuales de tráfico en autopistas estatales de peaje, proporcionados por el Ministerio de Fomento del Gobierno de España en su web: http://www.fomento.gob.es/BE/?nivel=2&orden=06000000

Leemos y limpiamos los datos:

Vamos a hacer lo mismo a todos los ficheros, pues tienen la misma estructura (excepto el de los datos globales "Total.", que no lo usaremos). 
El fichero de cada autopista contiene datos para hacer 2 tablas, una de datos totales y otra de datos mensuales. Contiene información de la longitud de la autopista, IMD de vehículos pesados y totales y variaciones respecto al año anterior de los IMDs.
La función lee_autopista va a borrar columnas y filas sin información, renombrar las columnas, poner los tipos adecuados a cada columnas (pues las columnas que deberían de venir con tipos numéricos no vienen así ni las que deberían de venir en formato fecha) y se va a quedar solamente con los datos mensuales, va a quitar los totales (con los que podría construirse otra tabla, en la función está implementado el código para ello pero no lo devuelve porque de momento no lo usaremos).
La función va a devolver sólo las columnas que vamos a estudiar, las fechas e IMD_total. El resto de columnas tienen dependencia lineal con esta columna (variaciones e IMD_pesados), por lo que no aportan información extra.

```{r }

autopista <- lee_autopista(fread("../dat/06020203_sevilla_cadiz.csv"))
# montmelo_la_junquera <- lee_autopista(fread("../dat/06020101_montmelo_la_junquera.csv"))

```

Empezamos analizando la autopista Sevilla-Cádiz:
Vamos a analizar con y sin aplicar logaritmos.

PRIMERO SIN APLICAR LOG.
1-Creo serie temporal:
```{r}

q1 <- autopista
# ts_mensual <- as_xts(q1, date_col = Mes_numeric)
ts_mensual <- ts(autopista$IMD_total, start=c(1990, 1), end=c(2017, 3), frequency=12)
plot(ts_mensual)
```

Summary
```{r}
summary(ts_mensual)
```


2-Descomposición estacional:
```{r}
fit <- stl(ts_mensual, s.window="period")
plot(fit)
```

```{r}

monthplot(ts_mensual, col=1:12, pch=19)

```

```{r}

seasonplot(ts_mensual, year.labels=TRUE, year.labels.left=TRUE, col=1:27, pch=19)

```

Clara estacionariedad con tendencia creciente el último año, aunque años anteriores se mantuvo sin tendencia ni ciclos(tren muestra tanto tendencia como ciclos).

Seleccionar 1 ventana de la serie temporal para train y otra para test:
```{r}

train <- window(ts_mensual, start=c(1990, 01), end=c(2014, 12))
plot(train)
```

```{r}

test <- window(ts_mensual, start=c(2015, 01), end=c(2016, 12)) 
plot(test)
```

3-Modelado exponencial ETS y predicción
```{r}
fit <- ets(train)
fit
```


```{r}
prediccion <- forecast(fit)
```

```{r}
par(mfrow=c(1,1))
plot(prediccion)
lines(test, col="red")
```

Precisión:
```{r}
accuracy(prediccion,test)
```

4-Modelado ARIMA y predicción:
```{r}
fit2 <- auto.arima(train)
fit2
```


```{r}
prediccion2 <- forecast(fit2)
prediccion2
```
```{r}
plot(prediccion2)
lines(test, col="red")
```

Precisión:
```{r}
accuracy(prediccion2,test)
```

Comparando con la anterior predice peor el de ARIMA (mayor RMSE).
```{r}
accuracy(prediccion,test)
```

Analizando los residuos: No se ve correlación, la distribución de residuos es normal y pasa el test de de portmanteau, luego los intervalos de predicción son fiables

```{r}
hist(residuals(fit2))

```


```{r}
tsdisplay(residuals(fit2))

```

```{r}
Box.test(residuals(fit2), type="Ljung")
```

Voy a probar a hacer lo mismo pero aplicando primero log:
1-B-Creo serie temporal:
```{r}
l.ts_mensual <- log(ts_mensual)
par(mfrow=c(2,1))
plot(ts_mensual)
plot(l.ts_mensual)


```

Summary:
```{r}
summary(l.ts_mensual)
```

2-B-Descomposición estacional:
```{r}
fit <- stl(l.ts_mensual, s.window="period")
plot(fit)
```

```{r}

monthplot(l.ts_mensual, col=1:12, pch=19)

```

```{r}


seasonplot(l.ts_mensual, year.labels=TRUE, year.labels.left=TRUE, col=1:27, pch=19)

```



```{r}

train <- window(l.ts_mensual, start=c(1990, 01), end=c(2014, 12)) 
plot(train)
```

```{r}

test <- window(l.ts_mensual, start=c(2015, 01), end=c(2016, 12))
plot(test)
```

3-B-Modelado exponencial ETS y predicción
```{r}
fit <- ets(train)
fit
```

```{r}
prediccion <- forecast(fit)
```

```{r}
par(mfrow=c(1,1))
plot(prediccion)
lines(test, col="red")
```

Precisión:
```{r}
accuracy(prediccion,test)
```

4-B-Modelado ARIMA y predicción:
```{r}
fit2 <- auto.arima(train)
fit2
```


```{r}
prediccion2 <- forecast(fit2)
prediccion2
```


```{r}
plot(prediccion2)
lines(test, col="red")
```

Precisión:
```{r}
accuracy(prediccion2,test)
```

Ahora el RMSE es menor en test de ETS y en train de ARIMA.
```{r}
accuracy(prediccion,test)
```

Analizando los residuos: No se ve correlación, la distribución de residuos es normal y pasa el test de de portmanteau, luego los intervalos de predicción son fiables 
```{r}
tsdisplay(residuals(fit2))

```

```{r}
hist(residuals(fit2))

```

```{r}
Box.test(residuals(fit2),  type="Ljung")
```

```{r}
#
```

