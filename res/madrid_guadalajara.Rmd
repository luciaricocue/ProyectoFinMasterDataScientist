---
title: "Proyecto Fin de Master"
author: "Lucía Rico Cuéllar"
date: "08 de julio de 2017"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    theme: united
    highlight: tango
---


```{r, include=FALSE}

library(data.table)
library(reshape)
library(zoo)
library(lubridate)
library(readr) 
library(stats)
library(xts)
library(tidyquant)
library(forecast)
library(ggplot2)
# setwd("C:/Users/Lucía/Desktop/ProyectoFinMasterDataScientist")
source("../src/funciones.R")

```



Vamos a usar los datos de series mensuales de tráfico en autopistas estatales de peaje, proporcionados por el Ministerio de Fomento del Gobierno de España en su web: http://www.fomento.gob.es/BE/?nivel=2&orden=06000000

Leemos y limpiamos los datos:

Vamos a hacer lo mismo a todos los ficheros, pues tienen la misma estructura (excepto el de los datos globales "Total.", que no lo usaremos). 
El fichero de cada autopista contiene datos para hacer 2 tablas, una de datos totales y otra de datos mensuales. Contiene información de la longitud de la autopista, IMD de vehículos pesados y totales y variaciones respecto al año anterior de los IMDs.
La función lee_autopista va a borrar columnas y filas sin información, renombrar las columnas, poner los tipos adecuados a cada columnas (pues las columnas que deberían de venir con tipos numéricos no vienen así ni las que deberían de venir en formato fecha) y se va a quedar solamente con los datos mensuales, va a quitar los totales (con los que podría construirse otra tabla, en la función está implementado el código para ello pero no lo devuelve porque de momento no lo usaremos).
La función va a devolver sólo las columnas que vamos a estudiar, las fechas e IMD_total. El resto de columnas tienen dependencia lineal con esta columna (variaciones e IMD_pesados), por lo que no aportan información extra.

```{r }

# autopista <- lee_autopista(fread("../dat/06020203_sevilla_cadiz.csv"))
# autopista <- lee_autopista(fread("../dat/06020101_montmelo_la_junquera.csv"))
# autopista <- lee_autopista(fread("../dat/06020102_barcelona_tarragona_A_7.csv"))
# autopista <- lee_autopista(fread("../dat/06020103_montmelo_papiol_A_7.csv"))
# autopista <- lee_autopista(fread("../dat/06020201_zaragoza_mediterraneo_A_2.csv"))
# autopista <- lee_autopista(fread("../dat/06020202_villalba_adanero_A_6.csv"))
# autopista <- lee_autopista(fread("../dat/06020301_tarragona_valencia_A_7.csv"))
# autopista <- lee_autopista(fread("../dat/06020302_valencia_alicante_A_7.csv"))
# autopista <- lee_autopista(fread("../dat/06020303_ferrol_fr_portuguesa_A_9.csv"))
# autopista <- lee_autopista(fread("../dat/06020401_bilbao_zaragoza_A_68.csv"))
# autopista <- lee_autopista(fread("../dat/06020402_burgos_armiñon_A_1.csv"))
# autopista <- lee_autopista(fread("../dat/06020403_leon_campomanes_A_66.csv"))
# autopista <- lee_autopista(fread("../dat/06020501_malaga_guadiaro.csv"))
# autopista <- lee_autopista(fread("../dat/06020502_alicante_cartagena.csv"))
# autopista <- lee_autopista(fread("../dat/06020503_avila_villacastin.csv"))
# autopista <- lee_autopista(fread("../dat/06020601_leon_astorga.csv"))
# autopista <- lee_autopista(fread("../dat/06020602_santiago_alto_sto_domingo.csv"))
# autopista <- lee_autopista(fread("../dat/06020603_segovia_san_rafael.csv"))
autopista <- lee_autopista(fread("../dat/06020701_madrid_guadalajara.csv"))
# autopista <- lee_autopista(fread("../dat/06020702_madrid_arganda.csv"))
# autopista <- lee_autopista(fread("../dat/06020703_madrid_navalcarnero.csv"))
# autopista <- lee_autopista(fread("../dat/06020801_madrid_ocaña.csv"))
# autopista <- lee_autopista(fread("../dat/06020802_eje_aeropuerto.csv"))
# autopista <- lee_autopista(fread("../dat/06020803_ocaña_la_roda.csv"))
# autopista <- lee_autopista(fread("../dat/06020901_madrid_toledo.csv"))
# autopista <- lee_autopista(fread("../dat/06020902_cartagena_vera.csv"))
# autopista <- lee_autopista(fread("../dat/06020903_circunvalacion_alicante.csv"))
# autopista <- lee_autopista(fread("../dat/06021001_alto_de_las_pedrizas_malaga.csv"))
```

##Analizamos ahora Madrid-Guadalajara:
##Vamos a analizar con y sin aplicar logaritmos.

##PRIMERO SIN APLICAR LOG.
###1-Creo serie temporal:
```{r}

q1 <- autopista
# ts_mensual <- as_xts(q1, date_col = Mes_numeric)
ts_mensual <- ts(autopista$IMD_total, start=c(2003, 10), end=c(2017, 3), frequency=12)
plot(ts_mensual)
```

Summary
```{r}
summary(ts_mensual)
```


###2-Descomposición estacional:
```{r}
fit <- stl(ts_mensual, s.window="period")
plot(fit)
```

```{r}

monthplot(ts_mensual, col=1:12, pch=19)

```

```{r}

seasonplot(ts_mensual, year.labels=TRUE, year.labels.left=TRUE, col=1:27, pch=19)

```

Estacional, comportamiento parece cíclico y tendencia constante el último periodo.

Seleccionar 1 ventana de la serie temporal para train y otra para test:
```{r}

train <- window(ts_mensual, start=c(2003, 10), end=c(2014, 12))
plot(train)
```

```{r}

test <- window(ts_mensual, start=c(2015, 01), end=c(2016, 12)) 
plot(test)
```

###3-Modelado exponencial ETS y predicción
```{r}
fit <- ets(train)
fit
```


```{r}
prediccion <- forecast(fit)
```

```{r}
par(mfrow=c(1,1))
plot(prediccion)
lines(test, col="red")
```

Precisión:
```{r}
accuracy(prediccion,test)
```

###4-Modelado ARIMA y predicción:
```{r}
fit2 <- auto.arima(train)
fit2
```


```{r}
prediccion2 <- forecast(fit2)
prediccion2
```
```{r}
plot(prediccion2)
lines(test, col="red")
```

Precisión:
```{r}
accuracy(prediccion2,test)
```

Comparando con la anterior predice peor el de ARIMA (mayor RMSE).
```{r}
accuracy(prediccion,test)
```

Analizando los residuos: Si se ve correlación, la distribución de residuos es normal y no pasa el test de de portmanteau (creo que lo pasaría a partir del 95%), luego los intervalos de predicción son fiables

```{r}
hist(residuals(fit2))

```


```{r}
tsdisplay(residuals(fit2))

```

```{r}
Box.test(residuals(fit2), type="Ljung")
```

##Voy a probar a hacer lo mismo pero aplicando primero log:
###1-B-Creo serie temporal:
```{r}
l.ts_mensual <- log(ts_mensual)
par(mfrow=c(2,1))
plot(ts_mensual)
plot(l.ts_mensual)


```

Summary:
```{r}
summary(l.ts_mensual)
```

###2-B-Descomposición estacional:
```{r}
fit <- stl(l.ts_mensual, s.window="period")
plot(fit)
```

```{r}

monthplot(l.ts_mensual, col=1:12, pch=19)

```

```{r}


seasonplot(l.ts_mensual, year.labels=TRUE, year.labels.left=TRUE, col=1:27, pch=19)

```



```{r}

train <- window(l.ts_mensual, start=c(2003, 10), end=c(2014, 12)) 
plot(train)
```

```{r}

test <- window(l.ts_mensual, start=c(2015, 01), end=c(2016, 12))
plot(test)
```

###3-B-Modelado exponencial ETS y predicción
```{r}
fit <- ets(train)
fit
```

```{r}
prediccion <- forecast(fit)
```

```{r}
par(mfrow=c(1,1))
plot(prediccion)
lines(test, col="red")
```

Precisión:
```{r}
accuracy(prediccion,test)
```

###4-B-Modelado ARIMA y predicción:
```{r}
fit2 <- auto.arima(train)
fit2
```


```{r}
prediccion2 <- forecast(fit2)
prediccion2
```


```{r}
plot(prediccion2)
lines(test, col="red")
```

Precisión:
```{r}
accuracy(prediccion2,test)
```

Ahora el RMSE es menor en test de ETS y en train de ARIMA.
```{r}
accuracy(prediccion,test)
```

Analizando los residuos: No se ve correlación , la distribución de residuos no es normal y no  pasa el test de de portmanteau (creo que es p-valor del 95%, entonces no lo pasa), luego los intervalos de predicción NO son fiables 
```{r}
tsdisplay(residuals(fit2))

```

```{r}
hist(residuals(fit2))

```

```{r}
Box.test(residuals(fit2),  type="Ljung")
```

```{r}
#
```

